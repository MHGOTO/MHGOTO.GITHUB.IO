<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Link Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS מינימלי חיוני */
        body { font-family: sans-serif; background: #0f172a; color: white; padding: 20px; }
        .glass { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        .btn-google { background: #4285F4; color: white; border: none; }
        .btn-google:disabled { opacity: 0.5; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; background: #334155; border: 1px solid #475569; color: white; border-radius: 8px; }
    </style>
</head>
<body>

    <h1 class="text-2xl font-bold text-center mb-4">Link Manager Pro</h1>
    <div id="debugParams" style="font-size: 10px; color: yellow; text-align: center; display: none;"></div>

    <div id="loginSection" class="glass text-center">
        <p class="mb-4">התחבר כדי לשמור ולסנכרן את הקישורים שלך</p>
        <button id="googleLoginBtn" class="btn btn-google">
            התחבר עם Google
        </button>
        <div id="errorMsg" class="text-red-400 text-sm mt-2 hidden"></div>
    </div>

    <div id="appSection" class="hidden">
        <div class="glass flex justify-between items-center">
            <span id="userName" class="font-bold"></span>
            <button id="logoutBtn" class="text-sm bg-red-600 px-3 py-1 rounded">יציאה</button>
        </div>

        <div class="glass">
            <h3 class="font-bold mb-2">הוסף חדש</h3>
            <form id="addForm">
                <input type="text" id="inpContent" placeholder="קישור או טקסט" required>
                <input type="text" id="inpDesc" placeholder="תיאור">
                <input type="text" id="inpCat" placeholder="קטגוריה">
                <button type="submit" class="btn bg-green-600 text-white">שמור</button>
            </form>
        </div>

        <div id="listContainer"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnRk-Os6EvJcFIdpl-lICc9w-E4pQ74nE",
            authDomain: "linkmanager-fdac5.firebaseapp.com",
            projectId: "linkmanager-fdac5",
            storageBucket: "linkmanager-fdac5.firebasestorage.app",
            messagingSenderId: "532683691813",
            appId: "1:532683691813:web:5cf639e32a715c626eeccc",
            measurementId: "G-NVN4E8TDGE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- לוגיקת התחברות חכמה ---

        // 1. בדיקה אם חזרנו מהפניה (Redirect) - קריטי לאפליקציות
        getRedirectResult(auth)
            .then((result) => {
                if (result) {
                    console.log("התחברות הצליחה!");
                }
            })
            .catch((error) => {
                console.error("שגיאת התחברות:", error);
                document.getElementById('errorMsg').innerText = `שגיאה: ${error.code} - ${error.message}`;
                document.getElementById('errorMsg').classList.remove('hidden');
                
                if (error.code === 'auth/unauthorized-domain') {
                    alert("שים לב!\nהדומיין הזה לא מאושר ב-Firebase.\nאם אתה מריץ כקובץ מקומי באפליקציה, זה לא יעבוד.\nעליך להעלות את האתר לרשת (GitHub/Netlify) ולטעון את הכתובת באפליקציה.");
                }
            });

        // 2. כפתור התחברות - משתמש רק ב-Redirect
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            const btn = document.getElementById('googleLoginBtn');
            btn.disabled = true;
            btn.innerText = "מעביר לגוגל...";
            
            const provider = new GoogleAuthProvider();
            
            try {
                // באפליקציות APK חובה להשתמש ב-Redirect ולא ב-Popup
                await signInWithRedirect(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                btn.disabled = false;
                btn.innerText = "התחבר עם Google";
                alert("שגיאה ביצירת הפניה: " + error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        // 3. ניהול מצב משתמש
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // מחובר
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                document.getElementById('userName').innerText = `שלום, ${user.displayName.split(' ')[0]}`;
                loadData(user);
            } else {
                // מנותק
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
                const btn = document.getElementById('googleLoginBtn');
                btn.disabled = false;
                btn.innerText = "התחבר עם Google";
            }
        });

        // --- לוגיקת דאטה בסיסית ---
        function loadData(user) {
            onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                const list = document.getElementById('listContainer');
                list.innerHTML = '';
                
                let items = [];
                if (docSnap.exists()) {
                    items = docSnap.data().items || [];
                }
                
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'glass';
                    div.innerHTML = `
                        <div class="font-bold text-blue-300 break-all">${item.content}</div>
                        <div class="text-sm text-gray-300">${item.description || ''}</div>
                        <div class="text-xs text-gray-500 mt-1">${item.category || ''}</div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const content = document.getElementById('inpContent').value;
            const description = document.getElementById('inpDesc').value;
            const category = document.getElementById('inpCat').value;

            // טעינה נוכחית והוספה
            // (בגרסה מלאה עדיף arrayUnion, כאן לצורך הפשטות קוראים ושומרים)
            // ... קוד הוספה רגיל ...
            alert("הפונקציונליות המלאה נמצאת בקובץ הקודם, זהו קובץ בדיקה להתחברות.");
        });

    </script>
</body>
</html>
