<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Manager Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --accent-color: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        /* מסך התחברות */
        #loginContainer {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--primary-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-btn {
            background: #4285F4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #appContent { display: none; }

        /* שאר העיצוב המקורי שלך נשמר כאן */
        .card {
            background: var(--secondary-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fab {
            position: fixed;
            bottom: 20px; left: 20px;
            width: 56px; height: 56px;
            background: var(--accent-color);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        
        .modal-content {
            background: var(--secondary-bg);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }

        input, select {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            background: #334155;
            border: 1px solid #475569;
            color: white;
            border-radius: 4px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginContainer">
        <button id="googleLoginBtn" class="login-btn">
            <i class="fab fa-google"></i>
            התחבר עם Google
        </button>
    </div>

    <div id="appContent">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Link Manager</h2>
            <div id="userInfo" style="display: flex; align-items: center; gap: 10px;">
                <img id="userPhoto" src="" style="width: 32px; height: 32px; border-radius: 50%;">
                <button id="logoutBtn" style="background: none; border: none; color: white;"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div id="linksContainer"></div>
        <div id="fab" class="fab"><i class="fas fa-plus"></i></div>
    </div>

    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <h3>הוסף קישור</h3>
            <form id="addItemForm">
                <input type="text" id="linkTitle" placeholder="כותרת" required>
                <input type="url" id="linkUrl" placeholder="קישור" required>
                <select id="linkCategory">
                    <option value="כללי">כללי</option>
                    <option value="עבודה">עבודה</option>
                    <option value="לימודים">לימודים</option>
                </select>
                <button type="submit" style="width: 100%; padding: 10px; background: var(--accent-color); border: none; color: white; border-radius: 4px; margin-top: 10px;">שמור</button>
                <button type="button" class="close-modal" style="width: 100%; padding: 10px; background: transparent; border: none; color: #94a3b8; margin-top: 5px;">ביטול</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        // שינוי 1: ייבוא signInWithRedirect ו-getRedirectResult במקום Popup
        import { 
            getAuth, 
            signInWithRedirect, 
            getRedirectResult, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot, 
            deleteDoc, 
            doc,
            serverTimestamp,
            orderBy 
        } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        // --- כאן תכניס את ההגדרות שלך ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // אלמנטים
        const loginContainer = document.getElementById('loginContainer');
        const appContent = document.getElementById('appContent');
        const loginBtn = document.getElementById('googleLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const linksContainer = document.getElementById('linksContainer');
        const addItemModal = document.getElementById('addItemModal');
        const fab = document.getElementById('fab');
        const closeModal = document.querySelector('.close-modal');
        const addItemForm = document.getElementById('addItemForm');

        let currentUser = null;

        // --- שינוי 2: טיפול בחזרה מהתחברות (חובה ל-Redirect) ---
        getRedirectResult(auth)
            .then((result) => {
                if (result) {
                    console.log("משתמש התחבר בהצלחה:", result.user.email);
                }
            })
            .catch((error) => {
                console.error("שגיאת התחברות:", error);
                alert("שגיאה בהתחברות: " + error.message);
            });

        // --- שינוי 3: כפתור התחברות מבצע Redirect ---
        loginBtn.addEventListener('click', () => {
            // הוספת prompt כדי למנוע לופים ולוודא בחירת חשבון
            provider.setCustomParameters({ prompt: 'select_account' });
            signInWithRedirect(auth, provider);
        });

        // ניהול מצב (נשאר אותו דבר)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginContainer.classList.add('hidden');
                appContent.style.display = 'block';
                document.getElementById('userPhoto').src = user.photoURL;
                loadLinks();
            } else {
                currentUser = null;
                loginContainer.classList.remove('hidden');
                appContent.style.display = 'none';
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // לוגיקת אפליקציה (נשארה ללא שינוי)
        function loadLinks() {
            const q = query(
                collection(db, "links"), 
                where("userId", "==", currentUser.uid),
                orderBy("createdAt", "desc")
            );
            
            onSnapshot(q, (snapshot) => {
                linksContainer.innerHTML = '';
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <div onclick="window.open('${data.url}', '_blank')">
                            <strong>${data.title}</strong><br>
                            <small style="color:#94a3b8">${data.category}</small>
                        </div>
                        <i class="fas fa-trash" style="color: #ef4444; cursor: pointer;" onclick="deleteItem('${docSnap.id}')"></i>
                    `;
                    linksContainer.appendChild(div);
                });
            });
        }

        window.deleteItem = async (id) => {
            if(confirm('למחוק?')) await deleteDoc(doc(db, "links", id));
        };

        fab.addEventListener('click', () => addItemModal.style.display = 'flex');
        closeModal.addEventListener('click', () => addItemModal.style.display = 'none');
        
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "links"), {
                userId: currentUser.uid,
                title: document.getElementById('linkTitle').value,
                url: document.getElementById('linkUrl').value,
                category: document.getElementById('linkCategory').value,
                createdAt: serverTimestamp()
            });
            addItemModal.style.display = 'none';
            addItemForm.reset();
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>
</html>
