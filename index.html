<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <title>Link Manager Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ×¡×’× ×•× ×•×ª ×‘×¡×™×¡ */
        :root {
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-primary: #1a1a1a;
            --radius: 12px;
            --accent-green: #00a651;
            --accent-gold: #f59e0b;
        }

        body.dark-mode {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --glass-bg: rgba(30, 41, 59, 0.95); 
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-primary: #f1f5f9;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            margin: 0;
            padding: 15px;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* ×¢×™×¦×•×‘ ×›×¨×˜×™×¡×™× ×•×¤×× ×œ×™× */
        .glass-panel, .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card {
            margin-bottom: 15px;
            padding: 15px;
            position: relative;
        }

        /* ×›×¤×ª×•×¨×™× ×•×¤×§×“×™× */
        button, select, input, textarea {
            font-family: 'Heebo', sans-serif;
            outline: none;
        }

        .action-btn {
            width: 100%; padding: 12px; border-radius: 8px; border: none;
            color: white; font-weight: bold; cursor: pointer;
            margin-bottom: 8px; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-google { background: #4285F4; }
        .btn-green { background: var(--accent-green); }
        
        /* ××¦×‘ ×›×¤×ª×•×¨ ×× ×•×˜×¨×œ */
        .btn-google:disabled { opacity: 0.7; cursor: not-allowed; }

        /* ××–×•×¨×™ ×ª×¦×•×’×” */
        #userSection, #controlsArea { margin-bottom: 20px; padding: 15px; }
        
        .hidden { display: none !important; }
        .flex { display: flex; }
        
        /* ×”×•×“×¢×•×ª ××¢×¨×›×ª */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 12px 24px; border-radius: 50px;
            opacity: 0; transition: 0.3s; pointer-events: none; z-index: 9999;
            text-align: center; width: max-content; max-width: 90%;
        }
        #toast.show { opacity: 1; bottom: 40px; }
    </style>
</head>
<body class="dark-mode">

    <header style="text-align:center; margin-bottom:20px;">
        <h1 style="font-size:1.8rem; font-weight:900;">Link Manager</h1>
        <div id="itemCount" style="font-size:0.9rem; opacity:0.8;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
    </header>

    <div id="userSection" class="glass-panel">
        <div id="loggedOutView">
            <button id="googleLoginBtn" class="action-btn btn-google">
                <i class="fab fa-google"></i> ×”×ª×—×‘×¨ ×¢× Google
            </button>
            <p style="font-size:0.8rem; text-align:center; margin-top:5px; opacity:0.7;">
                ×•×•×“× ×©×”×•×¡×¤×ª ××ª ×›×ª×•×‘×ª ×”××ª×¨ ×œ-Authorized Domains ×‘-Firebase
            </p>
        </div>
        <div id="loggedInView" class="hidden" style="justify-content: space-between; align-items: center;">
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="userAvatar" src="" style="width:40px; height:40px; border-radius:50%; border: 2px solid white;" alt="User">
                <div>
                    <div id="userName" style="font-weight:bold;"></div>
                    <div style="font-size:0.8rem; color:#00a651;">â— ××—×•×‘×¨</div>
                </div>
            </div>
            <button id="logoutBtn" style="background:rgba(255,255,255,0.1); border:1px solid currentColor; padding:5px 15px; border-radius:8px; color:inherit;">
                ×™×¦×™××”
            </button>
        </div>
    </div>

    <div id="controlsArea" class="glass-panel">
        <input type="search" id="searchInput" placeholder="ğŸ” ×—×™×¤×•×© ××”×™×¨..." style="width:100%; padding:12px; border-radius:8px; border:1px solid #555; background:rgba(255,255,255,0.05); color:inherit; margin-bottom:15px; font-size:16px;">
        
        <details>
            <summary style="cursor:pointer; padding:10px; font-weight:bold; background:rgba(255,255,255,0.05); border-radius:8px;">â• ×”×•×¡×£ ×¤×¨×™×˜ ×—×“×©</summary>
            <form id="addItemForm" style="margin-top:15px;">
                <textarea id="itemContent" rows="3" placeholder="×”×“×‘×§ ×›××Ÿ ×§×™×©×•×¨ ××• ×˜×§×¡×˜..." style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; background:rgba(255,255,255,0.05); color:inherit; border:1px solid #555; font-size:16px;"></textarea>
                <input type="text" id="itemDescription" placeholder="×ª×™××•×¨ ×§×¦×¨" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; background:rgba(255,255,255,0.05); color:inherit; border:1px solid #555;">
                <input type="text" id="itemCategory" placeholder="×§×˜×’×•×¨×™×” (×œ××©×œ: ×¡×¨×˜×™×)" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; background:rgba(255,255,255,0.05); color:inherit; border:1px solid #555;">
                <button type="submit" class="action-btn btn-green">×©××•×¨ ×‘×¢× ×Ÿ ğŸ’¾</button>
            </form>
        </details>
    </div>

    <div id="listContainer"></div>

    <div id="toast">×”×•×“×¢×”</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // ×ª×™×§×•×Ÿ: ×”×•×¡×¤×ª signInWithRedirect ×•×”×¡×¨×ª signInWithPopup ×× ×œ× ×‘×©×™××•×©, ××• ×”×©××¨×ª×• ×œ×™×ª×¨ ×‘×™×˜×—×•×Ÿ
        import { getAuth, signInWithRedirect, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnRk-Os6EvJcFIdpl-lICc9w-E4pQ74nE",
            authDomain: "linkmanager-fdac5.firebaseapp.com",
            projectId: "linkmanager-fdac5",
            storageBucket: "linkmanager-fdac5.firebasestorage.app",
            messagingSenderId: "532683691813",
            appId: "1:532683691813:web:5cf639e32a715c626eeccc",
            measurementId: "G-NVN4E8TDGE"
        };

        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let app, auth, db;
        let state = { items: [], user: null };

        // ××ª×—×•×œ
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase Init Error:", error);
            alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¢×¨×›×ª. × ×¡×” ×œ×¨×¢× ×Ÿ.");
        }

        // --- ×¤×•× ×§×¦×™×•×ª ---

        function renderList() {
            const list = document.getElementById('listContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            list.innerHTML = '';

            const filtered = state.items.filter(item => 
                (item.content && item.content.toLowerCase().includes(search)) ||
                (item.description && item.description.toLowerCase().includes(search)) ||
                (item.category && item.category.toLowerCase().includes(search))
            );

            document.getElementById('itemCount').innerText = `××¦×™×’ ${filtered.length} ×¤×¨×™×˜×™×`;

            if (filtered.length === 0) {
                list.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:30px; font-size:1.1rem;">×œ× × ××¦××• ×¤×¨×™×˜×™× ğŸ“­</div>';
                return;
            }

            // ××™×•×Ÿ: ×—×“×© ×œ××¢×œ×”
            filtered.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                
                // ×–×™×”×•×™ ×§×™×©×•×¨×™×
                const isLink = /^(http|https):\/\//.test(item.content);
                const contentHtml = isLink 
                    ? `<a href="${item.content}" target="_blank" style="color:#4285F4; font-weight:bold; word-break:break-all; text-decoration:underline;">${item.content}</a>`
                    : `<div style="font-weight:bold; word-break:break-all; white-space:pre-wrap;">${item.content}</div>`;

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span style="background:rgba(127,127,127,0.2); padding:2px 8px; border-radius:6px; font-size:0.75rem;">${item.category || '×›×œ×œ×™'}</span>
                        <span style="font-size:0.75rem; opacity:0.6;">${new Date(item.createdAt).toLocaleDateString('he-IL')}</span>
                    </div>
                    ${contentHtml}
                    <div style="margin-top:8px; opacity:0.9;">${item.description || ''}</div>
                    <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                        <button onclick="window.copyItem('${item.content.replace(/'/g, "\\'")}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">ğŸ“‹</button>
                        <button onclick="window.deleteItem(${item.id})" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">ğŸ—‘ï¸</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        window.addItem = async (e) => {
            e.preventDefault();
            if (!state.user) {
                alert("âš ï¸ ×¢×œ×™×š ×œ×”×ª×—×‘×¨ ×œ×—×©×‘×•×Ÿ Google ×›×“×™ ×œ×©××•×¨ × ×ª×•× ×™×.");
                return;
            }

            const content = document.getElementById('itemContent').value;
            const description = document.getElementById('itemDescription').value;
            const category = document.getElementById('itemCategory').value;

            if (!content) return;

            const newItem = {
                id: Date.now(),
                content,
                description,
                category,
                createdAt: new Date().toISOString()
            };

            state.items.unshift(newItem);
            showToast("×©×•××¨...");
            await saveToCloud();
            renderList();
            
            document.getElementById('addItemForm').reset();
            // ×¡×’×™×¨×ª ×”-Details ××—×¨×™ ×”×•×¡×¤×”
            document.querySelector('details').removeAttribute('open');
            showToast("×”×¤×¨×™×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”! âœ…");
        };

        window.deleteItem = async (id) => {
            if (confirm("×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§?")) {
                state.items = state.items.filter(i => i.id !== id);
                await saveToCloud();
                renderList();
                showToast("×”×¤×¨×™×˜ × ××—×§ ğŸ—‘ï¸");
            }
        };

        window.copyItem = (text) => {
            navigator.clipboard.writeText(text).then(() => showToast("×”×•×¢×ª×§ ×œ×œ×•×—! ğŸ“‹"));
        };

        async function saveToCloud() {
            if (!state.user) return;
            try {
                await setDoc(doc(db, "users", state.user.uid), { items: state.items });
            } catch (e) {
                console.error("Save error", e);
                alert("×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ: " + e.message);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- ×”×ª×—×‘×¨×•×ª (×”×—×œ×§ ×”××ª×•×§×Ÿ) ---
        
        const loginBtn = document.getElementById('googleLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        loginBtn.addEventListener('click', async () => {
            // 1. × ×˜×¨×•×œ ×”×›×¤×ª×•×¨ ×œ×× ×™×¢×ª ×œ×—×™×¦×•×ª ×›×¤×•×œ×•×ª
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××ª×—×‘×¨...';

            const provider = new GoogleAuthProvider();
            try {
                // 2. ×©×™××•×© ×‘-Redirect ×‘××§×•× Popup
                await signInWithRedirect(auth, provider);
            } catch (error) {
                console.error("Login Error:", error);
                // ×‘××§×¨×” ×©×œ ×©×’×™××” ××™×™×“×™×ª, ××—×–×™×¨×™× ××ª ×”×›×¤×ª×•×¨ ×œ×§×“××•×ª×•
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fab fa-google"></i> ×”×ª×—×‘×¨ ×¢× Google';

                if (error.code === 'auth/unauthorized-domain') {
                    alert("âŒ ×©×’×™××ª ×“×•××™×™×Ÿ!\n\n×”×›×ª×•×‘×ª ×©×œ ×”××ª×¨ ×‘-GitHub ×œ× ×××•×©×¨×ª ×‘-Firebase.\n×™×© ×œ×”×™×›× ×¡ ×œ-Firebase Console -> Authentication -> Settings -> Authorized Domains ×•×œ×”×•×¡×™×£ ××ª ×”×›×ª×•×‘×ª.");
                } else {
                    alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª:\n" + error.message);
                }
            }
        });

        logoutBtn.addEventListener('click', () => {
            if(confirm("×œ×”×ª× ×ª×§ ××”×—×©×‘×•×Ÿ?")) {
                signOut(auth);
            }
        });

        // ×”××–× ×” ×œ××¦×‘ ×”×ª×—×‘×¨×•×ª
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                document.getElementById('loggedOutView').classList.add('hidden');
                document.getElementById('loggedInView').classList.remove('hidden');
                document.getElementById('loggedInView').classList.add('flex');
                
                document.getElementById('userName').innerText = user.displayName.split(' ')[0]; // ×©× ×¤×¨×˜×™
                document.getElementById('userAvatar').src = user.photoURL;

                // ×˜×¢×™× ×ª × ×ª×•× ×™×
                onSnapshot(doc(db, "users", user.uid), (doc) => {
                    if (doc.exists()) {
                        state.items = doc.data().items || [];
                        renderList();
                    } else {
                        // ××©×ª××© ×—×“×©
                        state.items = [];
                        renderList();
                    }
                });
            } else {
                state.user = null;
                state.items = []; 
                renderList();
                document.getElementById('loggedOutView').classList.remove('hidden');
                document.getElementById('loggedInView').classList.add('hidden');
                document.getElementById('loggedInView').classList.remove('flex');
                
                // ××™×¤×•×¡ ×”×›×¤×ª×•×¨ ×œ××¦×‘ ×”×ª×—×œ×ª×™ ×× ×”×ª× ×ª×§× ×• ××• ×”×˜×¢×™× ×” × ×›×©×œ×”
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fab fa-google"></i> ×”×ª×—×‘×¨ ×¢× Google';
            }
        });

        document.getElementById('addItemForm').addEventListener('submit', window.addItem);
        document.getElementById('searchInput').addEventListener('input', renderList);

    </script>
</body>
</html>
