<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === Configuration ===
        const firebaseConfig = {
            apiKey: "AIzaSyBnRk-Os6EvJcFIdpl-lICc9w-E4pQ74nE",
            authDomain: "linkmanager-fdac5.firebaseapp.com",
            projectId: "linkmanager-fdac5",
            storageBucket: "linkmanager-fdac5.firebasestorage.app",
            messagingSenderId: "532683691813",
            appId: "1:532683691813:web:5cf639e32a715c626eeccc",
            measurementId: "G-NVN4E8TDGE"
        };

        const STORAGE_KEY = 'LinkManager_Pro_V7';
        const URL_REGEX = /^(https?:\/\/[^\s]+|t\.me\/[^\s]+|@\w+|[a-zA-Z0-9.-]+\.[a-z]{2,}\S*)/;
        
        const state = {
            items: [],
            trash: [], 
            user: null,
            unsubscribe: null,
            showDuplicates: true,
            toastTimeout: null
        };

        let app, auth, db;

        // === Initialization ===
        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setupFirebaseListeners();
            } catch (e) { 
                console.error("Firebase Init Error:", e);
                alert("×©×’×™××” ×‘××ª×—×•×œ: " + e.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ×‘×“×™×§×” ×”×× ×¨×¦×™× ×¢×œ file://
            if (window.location.protocol === 'file:') {
                alert("×©×’×™××” ×§×¨×™×˜×™×ª!\n\n×’×•×’×œ ×—×•×¡××ª ×”×ª×—×‘×¨×•×ª ××§×‘×¦×™× ××§×•××™×™× (file://).\n\n×—×•×‘×” ×œ×”×¨×™×¥ ××ª ×”×§×•×‘×¥ ×“×¨×š ×©×¨×ª ××§×•××™ (×›××• Live Server ×‘-VS Code) ××• ×œ×”×¢×œ×•×ª ××•×ª×• ×œ××™× ×˜×¨× ×˜.");
            }

            initApp();
            initTheme();
            loadLocalData();
            checkTrashExpiry(); 
            updateCategoryDropdowns();
            setupEventListeners();
            renderList();
        });

        // === Firebase Auth Logic ===
        function setupFirebaseListeners() {
            if (!auth) return;
            
            // ×”×××–×™×Ÿ ×”×–×” ×”×•× ×”×œ×‘ ×©×œ ×”××¢×¨×›×ª - ×”×•× ××–×”×” ××ª×™ ×”××©×ª××© × ×›× ×¡
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("××©×ª××© ×–×•×”×”:", user.email);
                    state.user = user;
                    
                    // ×¢×“×›×•×Ÿ ×××©×§ ××©×ª××©
                    document.getElementById('loggedOutView').style.display = 'none';
                    document.getElementById('loggedInView').style.display = 'flex';
                    document.getElementById('userName').textContent = user.displayName || '××©×ª××©';
                    document.getElementById('userAvatar').src = user.photoURL || 'https://via.placeholder.com/40';
                    
                    updateSyncStatus('syncing');
                    
                    // ×˜×¢×™× ×ª × ×ª×•× ×™×
                    if (state.unsubscribe) state.unsubscribe();
                    state.unsubscribe = onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                        if (docSnap.exists()) {
                            const d = docSnap.data();
                            if (JSON.stringify(d.items || []) !== JSON.stringify(state.items)) {
                                state.items = d.items || [];
                                state.trash = d.trash || [];
                                saveData(true);
                                updateCategoryDropdowns(); 
                                renderList();
                            }
                            updateSyncStatus('online');
                        } else {
                            // ×™×¦×™×¨×ª ××¡××š ×¨××©×•× ×™ ×œ××©×ª××© ×—×“×©
                            pushToCloud().then(() => showToast("×¤×¨×•×¤×™×œ ×¢× ×Ÿ × ×•×¦×¨!"));
                        }
                    }, (error) => {
                        console.error("×©×’×™××ª ×¡× ×›×¨×•×Ÿ:", error);
                        updateSyncStatus('error');
                    });
                } else {
                    console.log("××™×Ÿ ××©×ª××© ××—×•×‘×¨");
                    state.user = null;
                    if (state.unsubscribe) state.unsubscribe();
                    document.getElementById('loggedOutView').style.display = 'flex';
                    document.getElementById('loggedInView').style.display = 'none';
                }
            });
        }

        async function cloudLogin() {
            const btn = document.getElementById('googleLoginBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ ×¤×•×ª×— ×—×œ×•×Ÿ...';

            const provider = new GoogleAuthProvider();

            try {
                // ×©×™××•×© ×‘-Popup ×‘×œ×‘×“ (×”×›×™ ×××™×Ÿ ×œ×©×¨×ª ××§×•××™)
                const result = await signInWithPopup(auth, provider);
                console.log("×”×ª×—×‘×¨×•×ª ×”×¦×œ×™×—×”:", result.user.displayName);
                showToast("×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”!");
                // ×”-onAuthStateChanged ×™×˜×¤×œ ×‘×©××¨
            } catch (error) {
                console.error("×©×’×™××ª ×”×ª×—×‘×¨×•×ª:", error);
                
                let msg = "×©×’×™××” ×œ× ×™×“×•×¢×”";
                if (error.code === 'auth/popup-blocked') msg = "×”×—×œ×•×Ÿ ×”×§×•×¤×¥ × ×—×¡× ×¢×œ ×™×“×™ ×”×“×¤×“×¤×Ÿ. ×× × ××¤×©×¨ ×—×œ×•× ×•×ª ×§×•×¤×¦×™×.";
                if (error.code === 'auth/popup-closed-by-user') msg = "×¡×’×¨×ª ××ª ×”×—×œ×•×Ÿ ×œ×¤× ×™ ×¡×™×•× ×”×”×ª×—×‘×¨×•×ª.";
                if (error.code === 'auth/unauthorized-domain') msg = "×”×“×•××™×™×Ÿ ×”×–×” ×œ× ×××•×©×¨ ×‘-Firebase Console.\n×•×•×“× ×©×”×•×¡×¤×ª ××ª localhost ××• 127.0.0.1";
                if (error.code === 'auth/operation-not-allowed') msg = "×”×ª×—×‘×¨×•×ª ×‘×’×•×’×œ ×œ× ××•×¤×¢×œ×ª ×‘×¤×¨×•×™×§×˜ Firebase ×©×œ×š.";

                alert("×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª:\n" + msg + "\n\n×§×•×“ ×˜×›× ×™: " + error.code);
            } finally {
                btn.disabled = false;
                btn.textContent = '×”×ª×—×‘×¨ ×¢× Google';
            }
        }

        async function cloudLogout() { 
            if(auth && confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                await signOut(auth);
                // ×¨×¢× ×•×Ÿ ×”×“×£ ×›×“×™ ×œ××¤×¡ ××¦×‘×™×
                window.location.reload();
            } 
        }

        // === ×©××¨ ×”×¤×•× ×§×¦×™×•×ª ×œ×œ× ×©×™× ×•×™ ===
        
        function setupEventListeners() {
            document.querySelectorAll('.drop-trigger').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetId = btn.getAttribute('data-target');
                    const targetMenu = document.getElementById(targetId);
                    if (!targetMenu) return;
                    const isOpen = targetMenu.classList.contains('show');
                    closeAllMenus();
                    if (!isOpen) { targetMenu.classList.add('show'); btn.classList.add('active'); }
                });
            });
            window.addEventListener('click', () => closeAllMenus());

            document.getElementById('searchInput')?.addEventListener('input', () => window.requestAnimationFrame(renderList));
            document.getElementById('categoryFilter')?.addEventListener('change', renderList);
            document.getElementById('sortOrder')?.addEventListener('change', renderList);
            document.getElementById('addItemForm')?.addEventListener('submit', handleAdd);
            
            document.getElementById('toggleDarkModeBtn')?.addEventListener('click', toggleTheme);
            document.getElementById('toggleDuplicatesBtn')?.addEventListener('click', toggleDuplicates);
            document.getElementById('trashBtn')?.addEventListener('click', openTrashModal);
            document.querySelector('.btn-close-modal')?.addEventListener('click', closeTrashModal);
            document.getElementById('trashModal')?.addEventListener('click', (e) => { if(e.target.id === 'trashModal') closeTrashModal(); });

            document.getElementById('googleLoginBtn')?.addEventListener('click', cloudLogin);
            document.getElementById('logoutBtn')?.addEventListener('click', cloudLogout);
            document.getElementById('switchAccountBtn')?.addEventListener('click', () => { cloudLogout().then(cloudLogin); });

            ['importJsonInput', 'smartImportInput'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('click', (e) => e.target.value = null);
                    el.addEventListener('change', id === 'importJsonInput' ? importJson : smartImport);
                }
            });

            document.getElementById('exportJsonBtn')?.addEventListener('click', exportJson);
            document.getElementById('exportTxtBtn')?.addEventListener('click', exportTxt);
            document.getElementById('downloadHtmlBtn')?.addEventListener('click', downloadSite);
            document.getElementById('downloadSourceBtn')?.addEventListener('click', downloadSource);
        }

        function loadLocalData() {
            try {
                const embedded = document.getElementById('app-state').textContent;
                if(embedded && embedded.length > 5) {
                    const parsed = JSON.parse(embedded);
                    if (parsed.items) state.items = parsed.items;
                    if (parsed.trash) state.trash = parsed.trash;
                    return;
                }
            } catch(e) {}
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) { 
                try { 
                    const parsed = JSON.parse(stored);
                    state.items = parsed.items || [];
                    state.trash = parsed.trash || [];
                } catch(e) {} 
            }
        }

        function saveData(skipCloud = false) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ items: state.items, trash: state.trash }));
            if (!skipCloud && state.user && db) pushToCloud();
        }

        function checkTrashExpiry() {
            const now = new Date();
            const initialLen = state.trash.length;
            state.trash = state.trash.filter(item => {
                if (!item.deletedAt) return false;
                const diffDays = Math.ceil(Math.abs(now - new Date(item.deletedAt)) / (1000 * 60 * 60 * 24)); 
                return diffDays <= 30;
            });
            if(state.trash.length !== initialLen) saveData();
        }

        async function pushToCloud() {
            if (!state.user || !db) return;
            updateSyncStatus('syncing');
            try {
                await setDoc(doc(db, "users", state.user.uid), { items: state.items, trash: state.trash, lastUpdated: new Date().toISOString() }, { merge: true });
                updateSyncStatus('online');
            } catch (e) { 
                console.error("Push Error:", e);
                updateSyncStatus('error'); 
            }
        }

        function updateSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            if(!el) return;
            const dot = el.querySelector('.status-dot');
            if(dot) dot.className = `status-dot ${status}`;
            const text = status === 'online' ? '××—×•×‘×¨' : status === 'syncing' ? '××¡× ×›×¨×Ÿ...' : '×©×’×™××”';
            el.innerHTML = `<span class="status-dot ${status}"></span> ${text}`;
        }

        function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") : ''; }
        function closeAllMenus() { document.querySelectorAll('.dropdown-content, .drop-trigger').forEach(el => el.classList.remove('show', 'active')); }

        function updateCategoryDropdowns() {
            const cats = new Set(state.items.map(i => i.category));
            const select = document.getElementById('categoryFilter');
            const datalist = document.getElementById('categoriesDatalist');
            
            if(!select || !datalist) return;

            const currentVal = select.value;
            let html = '<option value="">ğŸ“‚ ×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>';
            let listHtml = '';
            
            [...cats].sort().forEach(c => {
                const s = escapeHtml(c);
                html += `<option value="${s}">${s}</option>`;
                listHtml += `<option value="${s}">`;
            });

            select.innerHTML = html;
            datalist.innerHTML = listHtml;
            
            if(currentVal && cats.has(currentVal)) select.value = currentVal;
            else select.value = "";
        }

        function renderList() {
            const container = document.getElementById('listContainer');
            if(!container) return;
            container.innerHTML = '';
            
            const query = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const catFilter = document.getElementById('categoryFilter')?.value || '';
            const sort = document.getElementById('sortOrder')?.value || 'date-new';

            let sortedFullList = [...state.items];
            const baseSort = (a, b) => {
                if (sort === 'name') return a.content.localeCompare(b.content);
                return b.date.localeCompare(a.date); 
            };
            sortedFullList.sort(baseSort);

            const total = sortedFullList.length;
            sortedFullList.forEach((item, index) => {
                if (sort === 'date-new') item.visualIndex = total - index;
                else item.visualIndex = index + 1;
            });

            const seen = new Set(), dups = new Set();
            sortedFullList.forEach(i => {
                const k = i.content.toLowerCase().trim();
                if (seen.has(k)) { i.isDup = true; dups.add(k); } else { i.isDup = false; seen.add(k); }
            });
            sortedFullList.forEach(i => { if(dups.has(i.content.toLowerCase().trim())) i.isDup = true; });

            const isHashSearch = /^#\s*\d+$/.test(query);
            const searchNum = isHashSearch ? parseInt(query.replace(/\D/g, '')) : null;

            let filtered = sortedFullList.filter(i => {
                if (isHashSearch) return i.visualIndex === searchNum;
                if (!state.showDuplicates && i.isDup && state.items.indexOf(i) !== state.items.findIndex(x => x.content.toLowerCase() === i.content.toLowerCase())) return false;
                const matchesSearch = !query || i.content.toLowerCase().includes(query) || i.description.toLowerCase().includes(query) || i.category.toLowerCase().includes(query) || (i.note && i.note.toLowerCase().includes(query));
                const matchesCat = !catFilter || i.category === catFilter;
                return matchesSearch && matchesCat;
            });

            document.getElementById('itemCount').textContent = `××¦×™×’ ${filtered.length} ××ª×•×š ${state.items.length}`;

            const pinnedItems = filtered.filter(i => i.isPinned);
            const regularItems = filtered.filter(i => !i.isPinned);

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">×œ× × ××¦××• ×ª×•×¦××•×ª</div>';
                return;
            }

            if (pinnedItems.length > 0) {
                const section = document.createElement('div');
                section.className = 'category-block';
                section.innerHTML = `
                    <div class="category-header" style="border-bottom: 2px solid var(--accent-gold);">
                        <h2 style="color: var(--accent-gold);">ğŸ“Œ ××•×¦××“</h2>
                        <span class="category-badge">${pinnedItems.length} ×¤×¨×™×˜×™×</span>
                    </div>
                    <div class="items-grid"></div>
                `;
                const grid = section.querySelector('.items-grid');
                pinnedItems.forEach(i => grid.appendChild(createCard(i, i.visualIndex)));
                container.appendChild(section);
            }

            const groups = {};
            regularItems.forEach(i => {
                if(!groups[i.category]) groups[i.category] = [];
                groups[i.category].push(i);
            });

            const sortedCategories = Object.keys(groups).sort((catA, catB) => {
                if (sort === 'date-new') {
                    const itemA = groups[catA][0];
                    const itemB = groups[catB][0];
                    return itemB.date.localeCompare(itemA.date);
                } else return catA.localeCompare(catB);
            });

            sortedCategories.forEach(cat => {
                const groupItems = groups[cat];
                const section = document.createElement('div');
                section.className = 'category-block';
                section.innerHTML = `
                    <div class="category-header">
                        <h2>${escapeHtml(cat)}</h2>
                        <span class="category-badge">${groupItems.length} ×¤×¨×™×˜×™×</span>
                    </div>
                    <div class="items-grid"></div>
                `;
                const grid = section.querySelector('.items-grid');
                groupItems.forEach(i => grid.appendChild(createCard(i, i.visualIndex)));
                container.appendChild(section);
            });
        }

        function createCard(item, displayNum) {
            const div = document.createElement('div');
            div.className = `card ${item.isPinned ? 'pinned' : ''}`;
            const safeContent = escapeHtml(item.content);
            const contentHtml = item.type === 'link' 
                ? `<a href="${safeContent}" class="card-link" target="_blank">${safeContent}</a>`
                : `<div class="card-text-content">${safeContent}</div>`;
            const noteHtml = item.note ? `<div class="card-note">${escapeHtml(item.note)}</div>` : '';

            div.innerHTML = `
                <div class="card-index">#${displayNum}</div>
                <div class="card-body">
                    ${contentHtml}
                    <div class="card-desc">${escapeHtml(item.description)}</div>
                    ${noteHtml}
                </div>
                <div class="card-footer">
                    <div>
                        <span class="tag-category">${escapeHtml(item.category)}</span>
                        <span class="duplicate-badge" style="display:${item.isDup ? 'inline' : 'none'}">×›×¤×•×œ</span>
                    </div>
                    <div class="card-actions">
                        <button class="icon-btn btn-copy" title="×”×¢×ª×§">ğŸ“‹</button>
                        <button class="icon-btn btn-edit" title="×¢×¨×•×š">âœï¸</button>
                        <button class="icon-btn pin-btn ${item.isPinned ? 'active' : ''}" title="${item.isPinned ? '×‘×˜×œ × ×¢×™×¦×”' : '× ×¢×¥'}">ğŸ“Œ</button>
                        <button class="icon-btn trash-btn" title="××—×§">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `;
            
            div.querySelector('.btn-copy').onclick = () => copyText(item.content);
            div.querySelector('.btn-edit').onclick = () => editItem(item);
            div.querySelector('.pin-btn').onclick = () => togglePin(item.id);
            div.querySelector('.trash-btn').onclick = () => moveToTrash(item.id);
            return div;
        }

        function handleAdd(e) {
            e.preventDefault();
            const content = document.getElementById('itemContent').value.trim();
            if (!content) return;
            
            const newItem = {
                id: Date.now(),
                content,
                description: document.getElementById('itemDescription').value.trim(),
                category: document.getElementById('itemCategory').value.trim() || '×›×œ×œ×™',
                note: document.getElementById('itemNote').value.trim(),
                date: new Date().toISOString(), 
                type: URL_REGEX.test(content) ? 'link' : 'text',
                isPinned: false
            };
            
            state.items.unshift(newItem); 
            onDataChange();
            e.target.reset();
            
            showToast('×”×¤×¨×™×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”', () => {
                state.items.shift();
                onDataChange();
            });
        }

        function moveToTrash(id) {
            const idx = state.items.findIndex(i => i.id === id);
            if(idx === -1) return;
            const item = state.items[idx];
            item.deletedAt = new Date().toISOString();
            
            state.trash.unshift(item);
            state.items.splice(idx, 1);
            onDataChange();
            
            showToast('×”×•×¢×‘×¨ ×œ×¡×œ ×”××—×–×•×¨', () => {
                restoreFromTrash(item.id, false); 
            });
        }

        function togglePin(id) {
            const idx = state.items.findIndex(i => i.id === id);
            if (idx !== -1) { 
                state.items[idx].isPinned = !state.items[idx].isPinned; 
                onDataChange(); 
            }
        }

        function editItem(item) {
            const oldItem = JSON.parse(JSON.stringify(item));
            const c = prompt('×ª×•×›×Ÿ:', item.content);
            if (c===null) return;
            item.content = c;
            item.description = prompt('×ª×™××•×¨:', item.description) || '';
            item.category = prompt('×§×˜×’×•×¨×™×”:', item.category) || '×›×œ×œ×™';
            item.note = prompt('×”×¢×¨×”:', item.note) || '';
            item.type = URL_REGEX.test(c) ? 'link' : 'text';
            onDataChange();
            
            showToast('×”×©×™× ×•×™ × ×©××¨', () => {
                const idx = state.items.findIndex(i => i.id === item.id);
                if(idx !== -1) state.items[idx] = oldItem;
                onDataChange();
            });
        }

        function onDataChange() { saveData(); updateCategoryDropdowns(); renderList(); }

        function showToast(msg, undoCallback) {
            const t = document.getElementById('toast');
            if (state.toastTimeout) clearTimeout(state.toastTimeout);
            
            t.textContent = msg;
            t.classList.add('visible');
            
            state.toastTimeout = setTimeout(() => {
                t.classList.remove('visible');
            }, 3000);
        }

        function openTrashModal() {
            const list = document.getElementById('trashList');
            list.innerHTML = '';
            if(state.trash.length === 0) list.innerHTML = '<div style="text-align:center; padding:20px;">×¨×™×§</div>';
            else state.trash.forEach(item => {
                const el = document.createElement('div');
                el.className = 'trash-item';
                el.innerHTML = `
                    <div class="trash-info"><strong>${escapeHtml(item.description)}</strong><br><small>${escapeHtml(item.content)}</small></div>
                    <div class="trash-actions"><button class="btn-restore">â™»ï¸</button><button class="btn-forever">âŒ</button></div>
                `;
                el.querySelector('.btn-restore').onclick = () => restoreFromTrash(item.id);
                el.querySelector('.btn-forever').onclick = () => deleteForever(item.id);
                list.appendChild(el);
            });
            document.getElementById('trashModal').classList.add('open');
        }
        function closeTrashModal() { document.getElementById('trashModal').classList.remove('open'); }
        
        function restoreFromTrash(id, notify = true) {
            const idx = state.trash.findIndex(i => i.id === id);
            if(idx === -1) return;
            const item = state.trash[idx];
            delete item.deletedAt;
            state.items.unshift(item);
            state.trash.splice(idx, 1);
            saveData(); 
            openTrashModal(); 
            renderList(); 
            if(notify) showToast('×©×•×—×–×¨');
        }
        
        function deleteForever(id) {
            if(!confirm('×œ××—×•×§ ×œ×¦××™×ª×•×ª?')) return;
            const idx = state.trash.findIndex(i => i.id === id);
            if(idx !== -1) { state.trash.splice(idx, 1); saveData(); openTrashModal(); }
        }

        function importJson(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev => { 
                try { 
                    const d = JSON.parse(ev.target.result);
                    if(Array.isArray(d)) state.items = d; else { state.items = d.items||[]; state.trash = d.trash||[]; }
                    onDataChange(); closeAllMenus(); alert('× ×˜×¢×Ÿ!'); 
                } catch(e){ alert('×©×’×™××”'); } 
            };
            r.readAsText(f);
        }

        function smartImport(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const lines = ev.target.result.split('\n');
                let added = 0;
                const map = new Map(state.items.map(i => [i.content.toLowerCase().trim(), i]));
                lines.forEach(l => {
                    const p = l.split('|').map(s => s.trim());
                    if (!p[0]) return;
                    if (!map.has(p[0].toLowerCase())) {
                        state.items.unshift({ id: Date.now()+added, content: p[0], description: p[1]||'', category: p[2]||'×›×œ×œ×™', date: new Date().toISOString(), type: URL_REGEX.test(p[0])?'link':'text', isPinned: false });
                        added++;
                    }
                });
                onDataChange(); closeAllMenus(); alert(`× ×•×¡×¤×•: ${added}`);
            };
            r.readAsText(f);
        }

        function exportJson() { downloadFile('backup.json', JSON.stringify({ items: state.items, trash: state.trash }, null, 2), 'application/json'); closeAllMenus(); }
        function exportTxt() { downloadFile('links.txt', state.items.map(i=>`${i.content} | ${i.description} | ${i.category}`).join('\n'), 'text/plain'); closeAllMenus(); }
        function downloadSite() { 
            closeAllMenus();
            document.getElementById('app-state').textContent = JSON.stringify({ items: state.items, trash: state.trash });
            downloadFile(`LinkManager_${new Date().toISOString().slice(0,10)}.html`, '<!DOCTYPE html>\n'+document.documentElement.outerHTML, 'text/html');
            document.getElementById('app-state').textContent = "{}";
        }
        function downloadSource() {
            closeAllMenus();
            document.getElementById('app-state').textContent = "{}";
            downloadFile('source.txt', '<!DOCTYPE html>\n'+document.documentElement.outerHTML, 'text/plain');
        }
        function downloadFile(n, c, t) { const b=new Blob([c],{type:t}), u=URL.createObjectURL(b), a=document.createElement('a'); a.href=u; a.download=n; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        async function copyText(t) { try { await navigator.clipboard.writeText(t); showToast('×”×•×¢×ª×§'); } catch (e) { prompt('×”×¢×ª×§:', t); } }
        function initTheme() { if(localStorage.getItem(STORAGE_KEY+'_theme')==='light') { document.body.classList.remove('dark-mode'); document.getElementById('toggleDarkModeBtn').textContent='ğŸŒ™'; } }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem(STORAGE_KEY+'_theme', document.body.classList.contains('dark-mode')?'dark':'light'); document.getElementById('toggleDarkModeBtn').textContent=document.body.classList.contains('dark-mode')?'â˜€ï¸':'ğŸŒ™'; }
        function toggleDuplicates() { state.showDuplicates=!state.showDuplicates; renderList(); }
    </script>
